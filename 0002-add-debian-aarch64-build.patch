From 48afb941e28c10acde98d7c8c70c41cf478542ea Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Leonard=20Janis=20Robert=20K=C3=B6nig?= <ljrk@ljrk.org>
Date: Wed, 9 Mar 2022 09:16:30 +0000
Subject: Add support for Debian arm64 build

---
 app/package.json               |  9 ++++++---
 tools/packaging/package-deb.js | 13 ++++++++++---
 tools/run-dist-electron.js     |  2 ++
 3 files changed, 18 insertions(+), 6 deletions(-)

diff --git a/app/package.json b/app/package.json
index dc9e5d1..45d331a 100644
--- a/app/package.json
+++ b/app/package.json
@@ -176,7 +176,8 @@
           "executableName": "threema-web",
           "platform": "linux",
           "arch": [
-            "x64"
+            "x64",
+            "arm64"
           ],
           "icons": {
             "48x48": "app/assets/icons/png/consumer-48x48.png",
@@ -194,7 +195,8 @@
           "executableName": "threema-work-web",
           "platform": "linux",
           "arch": [
-            "x64"
+            "x64",
+            "arm64"
           ],
           "icons": {
             "48x48": "app/assets/icons/png/work-48x48.png",
@@ -212,7 +214,8 @@
           "executableName": "threema-blue-web",
           "platform": "linux",
           "arch": [
-            "x64"
+            "x64",
+            "arm64"
           ],
           "icons": {
             "48x48": "app/assets/icons/png/blue-48x48.png",
diff --git a/tools/packaging/package-deb.js b/tools/packaging/package-deb.js
index e077352..7d243cd 100644
--- a/tools/packaging/package-deb.js
+++ b/tools/packaging/package-deb.js
@@ -19,11 +19,17 @@ async function main() {
     executableName += `-${getChannelName()}`;
   }
 
-  console.log(`Creating package for ${appDirName} (this may take a while)`);
+  /* Default to amd64/x64 */
+  if (ARCH_OUTNAME === undefined || ARCH_ELECTRON === undefined) {
+    ARCH_OUTNAME = "x64";
+    ARCH_ELECTRON = "amd64"
+  }
+
+  console.log(`Creating package for ${appDirName} on arch ${ARCH_OUTNAME} (this may take a while)`);
 
   const options = {
     desktopTemplate: "app/assets/desktop.ejs",
-    src: `app/build/dist-electron/packaged/${appDirName}-linux-x64/`,
+    src: `app/build/dist-electron/packaged/${appDirName}-linux-${ARCH_ELECTRON}/`,
     dest: "app/build/dist-electron/installers",
     name: appDirName,
     bin: executableName,
@@ -32,7 +38,7 @@ async function main() {
     genericName: "Threema Desktop Client",
     maintainer: "Threema GmbH <help@threema.ch>",
     icon: configs["linux-deb"][myArgs[0]]["icons"],
-    arch: "amd64",
+    arch: "${ARCH_OUTNAME}",
     homepage: "https://threema.ch",
     categories: ["Network", "InstantMessaging", "Chat"],
     description: "Desktop client for Threema (requires the mobile app)",
@@ -49,6 +55,7 @@ async function main() {
     console.error(err, err.stack);
     process.exit(1);
   }
+
 }
 
 main();
diff --git a/tools/run-dist-electron.js b/tools/run-dist-electron.js
index f4c4ca3..11c368c 100644
--- a/tools/run-dist-electron.js
+++ b/tools/run-dist-electron.js
@@ -15,6 +15,8 @@ import {
 import {signWindowsBinaryOrPackage} from "./signing/sign-windows.js";
 
 const DEV_ENV = process.env.DEV_ENV;
+const ARCH_OUTNAME = process.env.ARCH_OUTNAME;
+const ARCH_ELECTRON = process.env.ARCH_ELECTRON;
 const log = debug("dist-electron");
 
 let packageName = "";
-- 
2.47.1

